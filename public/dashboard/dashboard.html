<!DOCTYPE html>
<html lang="pt-br">

<head>
  <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon" />
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AquaTech | Dashboards</title>

  <link rel="stylesheet" href="../css/style_pergunta.css" />
  <script src="../js/sessao.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet" />

  <!-- scripts do Chart.js - 2022-1 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!--FONT AWESOME-->
  <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<body onload="validarSessao();gerarDashboard()">
  <div class="container_all">
    <div class="container_menu">
      <div class="menu_top">
        <div class="div_well_come">
          <h2>Bem vindo, <span id="b_usuario"></span></h2>
        </div>
        <ul>
          <li></li>
          <li>
            <a href="pergunta.html"><button>Pergunta</button></a>
          </li>
          <li>
            <a href="atualizarCadastro.html"><button>Atualizar cadastro</button></a>
          </li>
          <li>
            <a href="dashboard.html"><button>Dashboard</button></a>
          </li>
        </ul>
      </div>
      <button class="btn_sair" onclick="limparSessao()">Sair</button>
    </div>
    <div class="container_quest">
      <div class="container_kpi">
        <div class="kpis_usu">
          <div class="kpi">
            <h2>Seus acertos</h2>
            <h2 id="acertos_usuario"></h2>
          </div>
          <div class="kpi perg_resp">
            <h2>Perguntas Respondidas</h2>
            <h2 id="perguntas_usuario"></h2>
          </div>
        </div>
        <div class="kpis_global">
          <div class="kpi">
            <h2>Você está</h2>
            <h2 id="acima_usuario"></h2>
            <h2 id="desempenho_usuario_vs_global"></h2>
          </div>
          <div class="kpi acert_global">
            <h2>Acertos global</h2>
            <h2 id="acerto_global"></h2>
          </div>
        </div>
        <div class="ranking kpi">
          <h1>Ranking</h1>
          <div class="chart">
            <canvas id="myChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>

<script>
  var correta = "S";
  var errada = "N";
  var qtdTotalRespCorretas = 0;
  var qtdTotalRespErradas = 0;
  var totalRespostas = 0
  var qtdRespCorretasUsu = 0;
  var qtdRespErradasUsu = 0;
  var totalRespostasUsu = 0;

  function listarRespostasErradasCorretasPorUsuario(isCorreta) {
    var idUsuario = sessionStorage.ID_USUARIO;
    fetch(`/resposta/listarRespostas/${idUsuario}/${isCorreta}`, {
      method: "GET",
    })
      .then((res) => {
        res.json().then((json) => {
          console.log(json);
          if (isCorreta == "S") {
            console.log(json[0].corretas)
            qtdRespCorretasUsu = json[0].corretas
          } else {
            console.log(json[0].corretas)
            qtdRespErradasUsu = json[0].corretas
          }
        });
      })
      .catch((err) => {
        console.log(err);
      });
  }

  function listarRespostasPorUsuario() {
    var idUsuario = sessionStorage.ID_USUARIO;
    fetch(`/resposta/listarRespostas/${idUsuario}`, {
      method: "GET",
    })
      .then((res) => {
        res.json().then((json) => {
          console.log(json[0].corretas)
          totalRespostasUsu = json[0].corretas
          setTimeout(() => {
            perguntas_usuario.innerHTML = totalRespostasUsu
          }, 200);
        });
      })
      .catch((err) => {
        console.log(err);
      });
  }

  function listarRespostasCorretasErradas(isCorreta) {

    fetch(`/resposta/listarRespostasTotal/${isCorreta}`, {
      method: "GET",
    })
      .then((res) => {
        res.json().then((json) => {
          console.log(json);
          if (isCorreta == "S") {
            console.log(json[0].corretas)

            qtdTotalRespCorretas = json[0].corretas;
          } else {
            console.log(json[0].corretas)

            qtdTotalRespErradas = json[0].corretas
          }
        });
      })
      .catch((err) => {
        console.log(err);
      });
  }
  function listarRespostas() {
    fetch(`/resposta/listarRespostas`, {
      method: "GET",
    })
      .then((res) => {
        res.json().then((json) => {
          console.log(json);
          console.log(json[0].corretas)
          totalRespostas = json[0].corretas;
        });
      })
      .catch((err) => {
        console.log(err);
      });
  }
  var listaQuantidadeDeUsuarioRanking = [];
  var listaQuantidadeRespostasRanking = [];
  var listaQuantidadeRespostasCorretasRanking = []
  var listaNomeUsuarioRanking = [];
//   function listarRankingCorretas() {
//     fetch(`/resposta/listarRankingCorretas`, {
//       method: "GET",
//     })
//       .then((res) => {
//         res.json().then((json) => {
//           console.log(`Teste ranking: ${json}`)
//           for (var i = 0; i < json.length; i++) {
//           }
//         });
//       })
//       .catch((err) => {
//         console.log(err)
//       })
// }
  var listaAproveitamentoUsuario = []
  var totalRespostas = []
  function listarRankingRespostas(){
    fetch(`/resposta/listarRankingRespostas`,{
      method: "GET"
    }).then((res) => {
      res.json().then((json) =>{
        console.log(`Ranking Respostas: ${json}`)
        for (var i = json.length-1; i >= 0; i--) {
          console.log(json[i].aproveitamento)
          console.log(json[i].nome)
            listaAproveitamentoUsuario.push(json[i].aproveitamento)
            listaNomeUsuarioRanking.push(json[i].nome)
        }
      });
    }).catch((err) => {
      console.log(err)
    })
  }
  var porcentagemAcertos = 0;

  function calcularPorcentagemAcertosUsuario() {
    porcentagemAcertos = (qtdRespCorretasUsu / totalRespostasUsu * 100);
    console.log(`Porcentagem acertos usuario logado: ${porcentagemAcertos}`)
    acertos_usuario.innerHTML = `${porcentagemAcertos.toFixed(0)}%`;
  }
  var porcentagemAcertosTotal = 0;

  function calcularPorcentagemAcertosTotal() {
    porcentagemAcertosTotal = (qtdTotalRespCorretas / totalRespostas * 100);
    console.log(`Porcentagem acertos global: ${porcentagemAcertosTotal}`)
    acerto_global.innerHTML = `${porcentagemAcertosTotal.toFixed(0)}%`;
  }

  function mostrarQuantidadePerguntasRespondidas() {
    perguntas_usuario.innerHTML
  }

  function verificarDesempenhoUsuarioVsGlobal() {
    var desempenho_usuario = (((porcentagemAcertos - porcentagemAcertosTotal) / ((porcentagemAcertos + porcentagemAcertosTotal) / 2)) * 100)
    acima_usuario.innerHTML = `${(desempenho_usuario).toFixed(0)}%`
    var usuario = document.getElementById('acima_usuario')
    if (porcentagemAcertos > porcentagemAcertosTotal) {
      usuario.style.color = 'green'
      desempenho_usuario_vs_global.innerHTML = `Acima da média`
    } else {
      usuario.style.color = 'red'
      desempenho_usuario_vs_global.innerHTML = `Abaixo da média`
    }
  }
  function gerarDashboard() {
    listarRespostasErradasCorretasPorUsuario('S')
    listarRespostasErradasCorretasPorUsuario('N')
    listarRespostasPorUsuario()
    listarRespostasCorretasErradas('S')
    listarRespostasCorretasErradas('N')
    listarRespostas()
    listarRankingRespostas()
    setTimeout(() => {
      calcularPorcentagemAcertosUsuario()
      calcularPorcentagemAcertosTotal()
      mostrarQuantidadePerguntasRespondidas()
      verificarDesempenhoUsuarioVsGlobal()
      const ctx = document.getElementById("myChart");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: listaNomeUsuarioRanking,
      datasets: [{
        label: "Aproveitamento",
        data: listaAproveitamentoUsuario,
          borderWidth: 2,
          borderColor: "#4444ff",
          backgroundColor: "#4444ff",
      }],
    },
    option: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });
    }, 200);
  }
  
</script>